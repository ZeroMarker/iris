# 重要需求

## 罗定

### 下诊断插入医护人员类型匹配的诊查费
<!--rbctitle.hui.csp 号别职称设置-->
以出诊级别设置为模板改造
<!--rbcsessiontypeservice.hui.csp 出诊级别设置-->

```objectscript
/// 第一次插入诊断后插入挂号医嘱
/// w ##class(web.DHCOPAdmReg).InsertRegOrderDiag("300589","","","18881","","","","","")
```

### 抗菌药会诊完成后医师不可再开

w ##class(web.DHCDocMain).IsAntFinish()

### 停诊退所有的号

```objectscript
/// 停诊退所有的号
/// debug: w ##class(web.DHCDocMain).CancelRegAll("493||29")
ClassMethod CancelRegAll(rbas)
{
	q:rbas="" ""
	s UserId = 18973
	s GroupId = 238
	s Loc = 167
	s ReturnMR = "N"
	s ReturnReason = 54
	s RegFee = 0
	for {
		s RegFee = $o(^User.DHCRegistrationFeeI("RBASDr"," "_rbas,RegFee))
		q:RegFee=""
		s rtn = ##class(web.DHCOPAdmReg).CancelOPRegist(RegFee,UserId,GroupId,Loc,"","N",ReturnReason,"","")
	}
	q 0
}
```

### 获取指定小时内特定检验医嘱信息

```objectscript
/// 检验系统调用: 获取指定小时内特定检验医嘱信息 医嘱ID^^审核医嘱日期^审核医嘱时间^关联标本号
/// w ##class(web.DHCDocMain).GetSpecOrder("JY06392","0000901622",24)

```

### 门诊不足整包装药品插入药袋

```objectscript
/// @desc: 门诊不足整包装药品插入药袋 (特定剂型)
/// @debug: w ##class(web.DHCDocMain).CheckPackBaseQty("312031","441||1","3","6")

```

### 结算更改诊查费费别

```objectscript
/// 诊断费自动插入,费别可能不准确
/// 计费组调用 结算时更改诊查费费别 更改为其他医嘱的费别(优先慢病)
/// w ##class(web.DHCDocMain).UpdateOrdBillType(6255)
```

## 枣庄

### 挂号三天同科免费

OPAdm/Reg.hui.js
```
// 三日内非零挂号记录
s GetRegFeeThreeDayFlagMethod=##Class(websys.Page).Encrypt($lb("web.DHCOPAdmReg.GetRegFeeThreeDayFlag"))
//全局请求后台服务对象
var ServerObj={
	GetRegFeeThreeDayFlagMethod:"#(GetRegFeeThreeDayFlagMethod)#"
};
```

前端JS处理过滤默认三天同科免费

### 实现一元挂号优惠

```objectscript
/// Input: Itm: 收费项Id
/// 	   StDate：计费时间，可以为空，为空时取$h
/// 	   InsType：费别指针，可以为空，为空时按计费组的配置走
/// 	   PatType：病人就诊类型，可以为空(PA_Adm表PAADM_Epissubtype_DR->PAC_EpisodeSubType)
/// 	   OEPrice：自定价金额，自定价医嘱不能空
/// 	   HospId：医院指针，多院区时不能为空
/// 	   ExpStr：挂号优惠设置^医嘱Id^执行记录Id^就诊Id^接收科室Id^医嘱项Id^高值条码^打包子表Id^患者Id^就诊类型(挂号时使用)^库存项Id
/// Return：单价_"^"_折扣单价_"^"_记账单价_"^"_自付单价_"^"错误代码
/// Debug: w ##class(web.UDHCJFPRICE).GetItmPrice("7997",66519,"11","","","2","2^6821||4^^7488^^")
ClassMethod GetItmPrice(Itm As %String, StDate As %String, InsType As %String, PatType As %String, OEPrice As %String = "", HospId As %String = "", ExpStr As %String = "") As %String
{
    ...

	// 慢性病优惠 慢病优惠
	// 本院职工优惠(1元)
    // 儿童加收 多个收费项目 加收项目1元优惠为0,其他为1 使总和为1
	s list = $lb(13,12,17,18)
	if ($lf(list,RCDRowID) && (SubCat = 95) && (ZCFDesc '["知名专家")) {
		s DiscPrice = $fn(Price - 1,"",Decimal)
		s PatPrice = $fn(1,"",Decimal)
		s desc = ItmObj.TARIDesc
		if desc [ "加收" {
			s DiscPrice = $fn(Price - 0,"",Decimal)
			s PatPrice = $fn(0,"",Decimal)
		}
	}
	
	quit Price_"^"_DiscPrice_"^"_InsPrice_"^"_PatPrice_"^"_ErrMsg
}
```

### 扫医保凭证传入场景码

```objectscript
// 传入JS调用栈字符串

/*
scripts/Reg/Card.Common.Control.js
const regex = /scripts\/.*\.js/g;
stackTrace = stackTrace.match(regex);
stackTrace = stackTrace.join(',');
var domain = window.location;
//console.trace();
var list=$.cm({
    ClassName:"DHCDoc.OPDoc.PatientList",
    MethodName:"GessCardType",
    //dataType:"text",
    cardValue:CardNo,
    callStack:stackTrace
},false)
*/
// 根据调用的JS文件名取场景码
/// w ##class(web.DHCDocMain).ActionCode()
ClassMethod ActionCode(callStack As %String)
{
	//挂号
	s code = ""
	if (callStack["Reg.hui.js")||(callStack["scripts/OPDoc.RapidRegist.hui.js") {
		s code = 101
	}
	if callStack["dhcbill.ipbill.reg.js" {
		s code = 103
	}
	if (callStack["dhcbill.opbill.accdep.pay.js")||(callStack["dhcbill.ipbill.deposit.main.js") {
		s code = 104
	}
	if (callStack["scripts/dhcdoc/opdoc/patient.list.js")||(callStack["scripts/dhcnewpro/dhcem/patlist.js") {
		s code = 201
	}
	if callStack["scripts/nurse/hisui/nur.orderexcute.js" {
		s code = 203
	}
	if callStack["scripts/dhcnewpro/dhcem/nur.exec.hisui.js" {
		s code = 204
	}
	if (callStack["dhcbill.opbill.charge.patinfo.js")||(callStack["dhcbill.ipbill.charge.main.js") {
		s code = 301
	}
	if (callStack["scripts/pha/op/v4/fy.js")||(callStack["scripts/pha/herb/v2/opdisp.js") {
		s code = 302
	}
	q code
}
```

### 检查检验互认日志

```objectscript
/// desc: 互认日志查询, 医生是否查看是否互认
/// debug:	d ##class(%ResultSet).RunQuery("web.DHCDocMain", "HRLogQuery")

// hrlog.csp
```

### 中草药审核弹出预览窗口

```js
// scripts/dhcdoc/opdoc/UDHCOEOrder.CHNMEDEntry.js
// 总览打印搬运修改
UpdateClickHandlerFinish();
preview("确定", "destroyDialog('PrintDataPreView')");
```

### 医嘱录入自定义嘱托 用于插入嘱托医嘱同步医嘱备注

```js
//自定义嘱托
function CustomAdvice_Click() {
	var Selrowids = GetSelRowId();
	if (Selrowids == "") {
		createModalDialog("Custom_Advice",$g("自定义嘱托"), 600, 400,"icon-edit",$g("确定"),"","医嘱嘱托备注","CustomAdviceBtn","AddCustomAdvice()",true);
	}
	else {
		var OrderNote = GetCellData(Selrowids[0],"OrderDepProcNote")
		createModalDialog("Custom_Advice",$g("自定义嘱托"), 600, 400,"icon-edit",$g("同步备注"),OrderNote,"医嘱备注","CustomAdviceBtn","SyncOrderNote()",true);
	}
}
```
